# Синхронизация закупок и расходов

## Описание функциональности

При создании закупок на странице `/purchases` автоматически создаются соответствующие записи в разделе расходов `/expenses`.

### 1. Создание закупки
- При создании новой закупки автоматически создается расход типа **"Закупка товара"**
- Сумма расхода = общая сумма закупки в рублях (сумма TRY × курс лиры)
- Описание расхода: `Закупка у поставщика {название поставщика}`
- Дата расхода совпадает с датой закупки
- **В расход сохраняется информация о всех товарах закупки**

### 2. Оприходование закупки
- При оприходовании закупки с указанием расходов на доставку создается расход типа **"Логистика"**
- Сумма расхода = указанная сумма доставки в рублях
- Описание расхода: `Доставка закупки от {название поставщика}`
- Дата расхода = текущая дата

### 3. Отображение товаров на странице расходов
- В колонке "ТОВАР" отображается информация о товарах закупки
- Для расходов с небольшим количеством товаров (до 3) они показываются сразу
- Для расходов с большим количеством товаров:
  - Показывается количество товаров (например, "5 товаров")
  - При клике можно развернуть список или открыть детальное модальное окно
  - В модальном окне отображается полная таблица товаров с количеством и ценами
- Расходы типа "Прочее" с товарами закупки визуально выделяются зеленым цветом

## Техническая реализация

### Обновления в типах данных:

1. **Расширен интерфейс `Expense`:**
```typescript
export interface Expense {
  // ... существующие поля
  purchaseItems?: Array<{
    productName: string;
    quantity: number;
    unitCostTRY: number;
  }>;
}
```

### Изменения в `src/pages/Purchases.tsx`:

1. **Импорт API расходов:**
```typescript
import { productsApi, purchasesApi, expensesApi, type ApiProduct, type Purchase } from '../services/api';
```

2. **В функции `handleSubmit`:**
```typescript
// Подготавливаем информацию о товарах для расхода
const purchaseItemsForExpense = purchaseForm.items.map(item => {
  const product = products.find(p => p.id.toString() === item.productId);
  return {
    productName: product?.name || `Товар ID: ${item.productId}`,
    quantity: item.qty,
    unitCostTRY: item.unitCostTRY
  };
});

// Создаем расход для закупки
await expensesApi.create({
  date: purchaseForm.date,
  type: 'Прочее',
  description: `Закупка у поставщика ${purchaseForm.supplier}`,
  amount: totalAmountRUB,
  purchaseItems: purchaseItemsForExpense
});
```

3. **В функции `handleReceivePurchase`:**
```typescript
// Если есть расходы на доставку, создаем расход типа "Логистика"
if (receiveForm.deliveryExpenseRUB > 0) {
  try {
    await expensesApi.create({
      date: new Date().toISOString().split('T')[0],
      type: 'Логистика',
      description: `Доставка закупки от ${selectedPurchase.supplier}`,
      amount: receiveForm.deliveryExpenseRUB,
    });
  } catch (expenseError) {
    console.error('Failed to create logistics expense:', expenseError);
  }
}
```

### Изменения в `src/pages/Expenses.tsx`:

1. **Добавлен компонент `PurchaseItemsDisplay`** для отображения товаров закупки:
   - Показывает краткую информацию о количестве товаров
   - Позволяет развернуть список для небольшого количества товаров
   - Открывает модальное окно для большого количества товаров

2. **Добавлено модальное окно** для детального просмотра всех товаров закупки

3. **Визуальная индикация** - расходы типа "Прочее" с товарами закупки выделяются зеленым цветом

## Примечания

- Расходы создаются автоматически и сразу отображаются на странице расходов
- При ошибке создания расхода основной процесс (создание/оприходование закупки) не прерывается
- Все расходы синхронизируются с базой данных через API
- Информация о товарах сохраняется в базе данных и доступна для просмотра в любое время 